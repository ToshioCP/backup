# backup と restore

#### バックアップとリストアについて（アプリ作成の背景）

このアプリケーションはUBUNTUでの使用を前提としています。
Windowsなどの他のOSは対象外です。

バックアップは本来定期的にすべきですが、そうでない人が多いでしょう。
それでも再インストール、とくにクリーンインストールをするときは、どんな人でもバックアップを取ると思います。
（クリーンインストールとは、全てのデータを消去して新たにインストールすることです）。
バックアップの方法にはどんなものがあるでしょうか？

- コピーコマンドなどを使う
- バックアップ用のプログラムを作る
- バックアップ用のツールを使う

ざっと考えただけでもこのような方法があります。これらについて考えてみましょう。

これらの方法で共通しているのは、ファイルの内容は確実にコピーされる、ということです。
しかし、ファイルの属性についてはそうではありません。
ファイルの属性とは、作成日時、更新日時、所有者、パーミッション（どのユーザが読み書きできるか）などです。
これらがコピー先で保存されるかどうかに影響するのは、

- コピーに用いるコマンド（アプリケーション）
- コピー先のデバイスのフォーマットの種類

です。とくに2番目は見落としがちで、FAT系のフォーマットでは所有者情報とパーミッションは保存されません。
ですから、単純なファイルコピーではこれらの情報は失われてしまいます。
ファイル属性は、あまり問題にならないことが多いですが、時には大きな問題になることがあります。
例えば、gitではファイルの中身が同じなのに属性が違っているとファイルに変更が加えられたと判断されることがあります。

コピー先のデバイスの種類によらず、属性情報も保存するには、

- tarを使う
- UBUNTUに付属のバックアップというアプリを使う

方法があります。

バックアップアプリはあるフォルダ以下をまるごとバックアップするには便利です。
しかし、ファイルを選別してバックアップしたい場合には、細かい設定ができません。
その場合はプログラムを作成し、tarをその中で呼び出すようにすると良いです。

その際は、バックアップ先のデバイスのフォーマットに気をつける必要があります。
FATなどには1つのファイルの大きさの最大値があるので、tarファイルがあまりに大きくなるとその制限に引っかかります。
そのため

- 適度の大きさのディレクトリ単位でtarファイルを作るようにする
- 普通はホームディレクトリの1つ下のディレクトリを単位とすると良いと考えられる。
- ダウンロードしたアプリなどは（１）サイズが大きくなりがちで（２）そもそもダウンロードできるのでバックアップする価値が低い、ということから対象外とするのが良い

ということがいえます。

バックアップはただ丸ごとやるのではなく、対象を絞り、分割すると効率的になります。
時々の状況に応じたバックアップ用プログラムを自作するのは理にかなっているといえます。

このプログラムはこのような考えに基づいて作成されています。

#### 前提条件

- UBUNTU オペレーティングシステム
- Ruby version 3.1.2
- minitar

UBUNTU以外のLinuxでも動きます。
Rubyのバージョンは多少古くても動くと思います。
minitarはRubyのライブラリで、gemコマンドでインストールします。

~~~
$ gem install minitar
~~~

#### 使い方

ホームディレクトリのバックアップを想定しています。

1. すべてのファイルをホームディレクトリ直下に置く。
2. backup_conf.rbを編集する。
3. backup.rbでバックアップをとる。（$ ruby backup.rb）
4. restore.rbでリストアする。（$ ruby restore.rb）

#### minitarについて

minitarはrubyのライブラリで、tarと同じ書庫を作り、解凍することができます。
詳しくは[rubygems](https://rubygems.org/)でminitarを検索し、ドキュメントを見てください。
使い方は簡単です。
ドキュメントのサンプルが参考になります。

このプログラムでは圧縮も行っています。
圧縮方式はgzです。
そのためにzlibライブラリを使っています。
このライブラリはrubyのインストール時にすでに入っていますが、requireで取り込む必要があります。
マニュアルは[Rubyのドキュメント](https://docs.ruby-lang.org/ja/3.0/doc/index.html)の「all libraries」に入っています。

#### ライセンス

ライセンスは[GPLv3](https://www.gnu.org/licenses/gpl-3.0.html)とします。
このプログラムは自由に使用、配布、変更できますが、全くの無保証であることに注意してください。
特にバックアップとリストアはリスキーな操作であるため、ご自分の判断でなさってください。
